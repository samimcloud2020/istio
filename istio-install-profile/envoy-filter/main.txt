----------------------------------------------------Envoy Filter------------------------------------------------------
The EnvoyFilter resource allows you to customize the Envoy configuration that gets generated by the Istio Pilot.

Using the resource you can update values, add specific filters, or even add new listeners, clusters, etc. 

Use this feature with care, as incorrect customization might destabilize the entire mesh.

The filters are additively applied, meaning there can be any number of filters for a given workload in a specific namespace.

The filters in the root namespace (e.g. istio-system) are applied first, followed by all matching filters in the workloadsâ€™ namespace.

---------------------------------EnvoyFilter that adds a header called api-version to the request.-----------------------------
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: http-ingress-gateway
spec:
  # The selector matches the ingress gateway pod labels.
  # If you installed Istio using Helm following the standard documentation, this would be "istio=ingress"
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 8080
      name: http
      protocol: HTTP
    hosts:
      - "som.trycloud.co.in"   # domain name of external website
      - "sam.trycloud.co.in"
---    
kind: VirtualService
apiVersion: networking.istio.io/v1alpha3
metadata:
  name: productpage-vs1
  namespace: default
spec:
  hosts:
    - "som.trycloud.co.in"     # which incoming hosts are we applying proxy rules to. so copy the value of gateway host always
    #- fleetman-webapp.default.svc.cluster.local
  gateways:
    - http-ingress-gateway
  http:
    - route:
        - destination:
            host: productpage
            subset: v1
          weight: 50
---
kind: VirtualService
apiVersion: networking.istio.io/v1alpha3
metadata:
  name: productpage-vs2
  namespace: default
spec:
  hosts:
    - "sam.trycloud.co.in"     # which incoming hosts are we applying proxy rules to. so copy the value of gateway host always
    #- fleetman-webapp.default.svc.cluster.local
  gateways:
    - http-ingress-gateway
  http:
    - route:
        - destination:
            host: productpage
            subset: v2
          weight: 50
       
---
kind: DestinationRule
apiVersion: networking.istio.io/v1alpha3
metadata:
  name: productpage-ds1
  namespace: default
spec:
  host: productpage
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets:
    - labels:
        version: v1
      name: v1
    - labels:
        version: v2
      name: v2
   
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: api-header-filter
  namespace: default
spec:
  workloadSelector:
    labels:
      version: v1    # this label is on workload , which connect gateway
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.http_connection_manager"
            subFilter:
              name: "envoy.router"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.lua
        typed_config:
          "@type": "type.googleapis.com/envoy.config.filter.http.lua.v2.Lua"
          inlineCode: |
            function envoy_on_response(response_handle)
              response_handle:headers():add("api-version", "v1")
            end

            
If you send a request to the $GATEWAY_URL you can notice the api-version header is added, as shown below:

$ curl -s -I -X HEAD  http://$GATEWAY_URL
HTTP/1.1 200 OK
x-powered-by: Express
content-type: text/html; charset=utf-8
content-length: 2471
etag: W/"9a7-hEXE7lJW5CDgD+e2FypGgChcgho"
date: Tue, 17 Nov 2020 00:40:16 GMT
x-envoy-upstream-service-time: 32
api-version: v1   <----------------------------------------------------------
server: istio-envoy


samim@ip-172-31-27-156:~/istio-1.18.1$ curl -s -I -X HEAD http://sam.trycloud.co.in:32479
HTTP/1.1 200 OK
server: istio-envoy   <-------------------------------------------------------
date: Sat, 22 Jul 2023 06:59:44 GMT
content-type: text/html; charset=utf-8
content-length: 1683
x-envoy-upstream-service-time: 2


